<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vialundskolans MoodCam</title>
  <style>
    :root{--bg:#0b0f14;--fg:#e7effa;--panel:#0f172a;--panel2:#111827;--border:#1f2937;--accent:#22c55e}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,sans-serif}
    #stage{display:grid;grid-template-columns:1fr;gap:16px;height:100vh;align-items:center;justify-items:center;padding:12px}
    .topbar{position:fixed;top:10px;left:10px;display:flex;gap:8px;z-index:10}
    .btn{background:var(--panel2);border:1px solid var(--border);color:var(--fg);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .layer-wrap{position:relative;display:inline-block;border-radius:12px;overflow:hidden;box-shadow:0 12px 36px rgba(0,0,0,.5);max-width:96vw;max-height:86vh}
    video{display:block;width:100%;height:auto}
    canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}

    /* Kompakt moodm√§tare utan rubrik, centrerad vid kamerans nederkant */
    #meterWrap{
      position:absolute;left:50%;transform:translateX(-50%);bottom:0;
      background:var(--panel);border:1px solid var(--border);
      border-bottom-left-radius:0;border-bottom-right-radius:0;border-top-left-radius:10px;border-top-right-radius:10px;
      padding:6px 10px;width:min(360px,70%);z-index:5
    }
    #meterBar{position:relative;height:8px;background:#0d1218;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
    #meterFill{height:100%;width:0%;background:linear-gradient(90deg,#2dd4bf,#22c55e)}
    .meterVal{position:absolute;right:6px;top:-16px;opacity:.85}
    .small{font-size:12px;opacity:.8}

    /* Settings-panel (dold tills man klickar) */
    #settings{display:none;position:fixed;right:12px;top:52px;width:320px;max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px 12px 8px;z-index:20}
    #settings h3{margin:6px 0 8px 0;font-size:16px}
    #settings .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    #settings label{font-size:14px}
    details{border:1px dashed var(--border);border-radius:8px;padding:6px}
    summary{cursor:pointer}

    .hud{position:fixed;left:14px;bottom:14px;font-size:12px;opacity:.7}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
</head>
<body>
  <div class="topbar">
    <button id="start" class="btn">Starta kamera</button>
    <button id="settingsBtn" class="btn">Settings</button>
  </div>

  <div id="stage">
    <div class="layer-wrap" id="wrap">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>

      <!-- Kompakt moodm√§tare -->
      <div id="meterWrap">
        <div id="meterBar">
          <div id="meterFill"></div>
          <span id="meterVal" class="small meterVal">0</span>
        </div>
        <div class="small" style="margin-top:4px">
          Moodm√§tare ‚Äì √ñkar n√§r n√•gon √§r <em>Glad</em> 5s i str√§ck, s√• smile for the camera.
        </div>
      </div>
    </div>
  </div>

  <!-- Settings (dold initialt) -->
  <div id="settings">
    <h3>Settings</h3>

    <div class="row">
      <label for="camSel">Kamera</label>
      <select id="camSel" class="btn" style="width:190px"></select>
    </div>

    <div class="row">
      <label for="conf">Konfidens (etikett)</label>
      <input id="conf" type="range" min="0.2" max="0.9" step="0.05" value="0.40">
    </div>

    <div class="row">
      <label for="inputSize">Detector size</label>
      <input id="inputSize" type="range" min="224" max="512" step="32" value="320">
    </div>

    <details style="margin-top:8px">
      <summary>Peppande one-liners</summary>
      <div class="row" style="margin-top:8px">
        <label>Aktivera</label><input type="checkbox" id="peppToggle">
      </div>
      <div class="row">
        <label for="peppCat">Kategori</label>
        <select id="peppCat" class="btn" style="width:190px">
          <option value="all">Alla</option>
          <option value="skola">Skola</option>
          <option value="maende">M√•ende</option>
          <option value="basta">G√∂r ditt b√§sta</option>
          <option value="van">V√§nskap</option>
        </select>
      </div>
      <p class="small">Visas i varje ansiktsruta, l√§ngst ned, och byts ~var 30:e sekund.</p>
    </details>

    <details style="margin-top:8px">
      <summary>Teman (overlays)</summary>
      <div class="row" style="margin-top:8px">
        <label>Aktivera teman</label><input type="checkbox" id="themeToggle">
      </div>
      <div class="row">
        <label for="themeSel">Tema</label>
        <select id="themeSel" class="btn" style="width:190px">
          <option value="none">‚Äî</option>
          <option value="halloween">Halloween</option>
          <option value="jul">Jul</option>
          <option value="sommar">Sommar</option>
          <option value="nyar">Ny√•r</option>
          <option value="film">Film-tema</option>
          <option value="gaming">Gaming</option>
        </select>
      </div>
      <p class="small">L√§gg PNG i <code>/img/&lt;tema&gt;/...</code> + <code>manifest.json</code>. Om manifest saknas ritas inga overlays.</p>
    </details>

    <details style="margin-top:8px">
      <summary>Bes√∂kslogg</summary>
      <div class="row" style="margin-top:8px">
        <button id="dlLog" class="btn">Ladda ner CSV</button>
        <button id="clearLog" class="btn" style="background:#581c1c;border-color:#7f1d1d">Nollst√§ll</button>
      </div>
      <p id="logInfo" class="small"></p>
    </details>
  </div>

  <div class="hud">Allt k√∂rs lokalt i datorn. -Kristoffer</div>

<script>
/* ---------- Konstanter & state ---------- */
const EMO_SV = { angry:"Arg", disgusted:"√Ñcklad", fearful:"R√§dd", happy:"Glad", neutral:"Neutral", sad:"Ledsen", surprised:"F√∂rv√•nad" };
const EMO_EMOJI = { angry:"üò†", disgusted:"ü§¢", fearful:"üò®", happy:"üòÑ", neutral:"üòê", sad:"üò¢", surprised:"üòÆ" };
const EMO_COLOR = { happy:"#28c728", angry:"#2a2ae0", sad:"#c07800", surprised:"#c0c000", fearful:"#00b4b4", disgusted:"#00a078", neutral:"#b0b0b0" };

let EMO_CONF_MIN = 0.40;
let DETECTOR_SIZE = 320;

let peppEnabled = false;
let peppCat = 'all';

let themeEnabled = false;
let themeName = 'none';
let themeManifest = null;     // laddas fr√•n /img/<tema>/manifest.json
const themeCache = new Map(); // path -> HTMLImageElement

let LANDMARKS_AVAILABLE = false;

let video, overlay, ctx;
let currentStream = null;

const tracks = [];            // {id,bbox:[x,y,w,h],last,happyStreak,counted,seenFrames,peppText,lastPepp,effectSet:{}}
let nextId = 1;

let lastFrameTime = performance.now();

let meterTarget = 0;
let meterShown = 0;
const METER_EASE = 0.05;

const RESET_H = 19, RESET_M = 30;

const visitorsByDay = JSON.parse(localStorage.getItem('moodcam.visitors') || '{}');
updateLogInfo();

/* ---------- Hj√§lp ---------- */
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function scheduleResetIfNeeded(){ const now=new Date(); const reset=new Date(); reset.setHours(RESET_H, RESET_M, 0, 0); if (Math.abs(now-reset)<1000){ meterTarget=0; meterShown=0; } }
function iou(a,b){ const [ax,ay,aw,ah]=a,[bx,by,bw,bh]=b; const x1=Math.max(ax,bx),y1=Math.max(ay,bx?by:by),x2=Math.min(ax+aw,bx+bw),y2=Math.min(ay+ah,bx?by+bh:by+bh); const inter=Math.max(0,x2-x1)*Math.max(0,y2-y1), union=aw*ah+bw*bh-inter; return union>0? inter/union:0; }

function drawLabel(x,y,text){
  ctx.font='16px system-ui';
  ctx.textAlign='left';
  ctx.textBaseline='alphabetic';
  const pad=6, h=18, w=ctx.measureText(text).width;
  ctx.fillStyle='rgba(0,0,0,0.85)';
  ctx.fillRect(x-pad,y-h-pad,w+pad*2,h+pad*2);
  ctx.fillStyle='#fff';
  ctx.fillText(text,x,y);
}

function drawCenteredBottom(x,y,w,h,text){
  ctx.font='16px system-ui';
  ctx.textAlign='left';
  ctx.textBaseline='alphabetic';
  const pad=6, htxt=18, tw=ctx.measureText(text).width;
  const cx=x+w/2 - tw/2;
  const cy=y+h - 8;
  ctx.fillStyle='rgba(0,0,0,0.7)';
  ctx.fillRect(cx-pad,cy-htxt-pad,tw+pad*2,htxt+pad*2);
  ctx.fillStyle='#fff';
  ctx.fillText(text,cx,cy);
}

function syncOverlaySize(){ overlay.width=video.videoWidth; overlay.height=video.videoHeight; overlay.style.width=video.clientWidth+'px'; overlay.style.height=video.clientHeight+'px'; }

/* ---------- Pepp ---------- */
const PEPP = {
  skola:["Du g√∂r klassrummet b√§ttre bara genom att vara h√§r.","Kunskap + nyfikenhet = superkraft!","St√§ll en fr√•ga ‚Äì n√•gon annan undrar samma sak."],
  maende:["Du duger precis som du √§r. üíô","Ta tre djupa andetag ‚Äì du fixar det.","Sm√• steg r√§knas ocks√•."],
  basta:["G√∂r ditt b√§sta idag ‚Äì det r√§cker l√•ngt.","Fokusera p√• n√§sta lilla f√∂rb√§ttring.","Misstag = data f√∂r att bli vassare."],
  van:["Har du kramat n√•gon idag? ü§ó","S√§g till en v√§n hur mycket hen betyder f√∂r dig.","Le mot n√•gon ‚Äì du √§ndrar n√•gons dag."]
};
const PEPP_INTERVAL = 30_000;
function randomPepp(){ const cats=peppCat==='all'?Object.keys(PEPP):[peppCat]; const cat=cats[Math.floor(Math.random()*cats.length)]; const arr=PEPP[cat]; return arr[Math.floor(Math.random()*arr.length)]; }

/* ---------- Overlays (teman) ---------- */
async function loadThemeManifest(theme){
  themeManifest=null; if(!theme || theme==='none') return;
  try{
    const resp=await fetch(`./img/${theme}/manifest.json`,{cache:'no-store'}); if(!resp.ok) return;
    const data=await resp.json(); themeManifest=data;
    const paths=[]; Object.values(data).forEach(arr=>Array.isArray(arr)&&arr.forEach(p=>paths.push(`./img/${theme}/${p}`)));
    await Promise.all(paths.map(p=>cacheImage(p)));
  }catch(e){}
}
function cacheImage(src){ if(themeCache.has(src)){ const im=themeCache.get(src); return im.decode?.()??Promise.resolve(); } const img=new Image(); img.src=src; themeCache.set(src,img); return img.decode?.()??new Promise(res=>{img.onload=res;img.onerror=res;}); }
function pickFrom(arr){ return arr && arr.length ? arr[Math.floor(Math.random()*arr.length)] : null; }
function assignEffects(track){ if(!themeEnabled || !themeManifest){ track.effectSet=null; return; } track.effectSet={ hat:pickFrom(themeManifest.hats), glasses:pickFrom(themeManifest.glasses), teeth:pickFrom(themeManifest.teeth), beard:pickFrom(themeManifest.beard), makeup:pickFrom(themeManifest.makeup), mouth:pickFrom(themeManifest.mouths)}; }
function drawImageFit(imgPath,x,y,w,h){ const img=themeCache.get(`./img/${themeName}/${imgPath}`); if(!img) return; ctx.drawImage(img,x,y,w,h); }
function drawEffects(track,x,y,w,h){ if(!themeEnabled || !track.effectSet) return; const e=track.effectSet; if(e.hat)drawImageFit(e.hat,x+w*0.10,y-h*0.35,w*0.80,h*0.45); if(e.glasses)drawImageFit(e.glasses,x+w*0.20,y+h*0.28,w*0.60,h*0.22); if(e.teeth)drawImageFit(e.teeth,x+w*0.35,y+h*0.65,w*0.30,h*0.18); if(e.beard)drawImageFit(e.beard,x+w*0.25,y+h*0.62,w*0.50,h*0.35); if(e.makeup)drawImageFit(e.makeup,x+w*0.15,y+h*0.18,w*0.70,h*0.70); if(e.mouth)drawImageFit(e.mouth,x+w*0.42,y+h*0.62,w*0.16,h*0.12); }

/* ---------- Kamera ---------- */
async function listCams(defaultIndex=1){ const sel=document.getElementById('camSel'); sel.innerHTML=''; const dev=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput'); dev.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Kamera ${i+1}`; sel.appendChild(o); }); if(dev.length) sel.selectedIndex=Math.min(defaultIndex,dev.length-1); }
async function startCamera(deviceId){ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); const constraints=deviceId?{video:{deviceId:{exact:deviceId},width:{ideal:960},height:{ideal:540}}}:{video:{width:{ideal:960},height:{ideal:540}}}; currentStream=await navigator.mediaDevices.getUserMedia(constraints); video.srcObject=currentStream; await new Promise(r=>video.onloadedmetadata=r); syncOverlaySize(); }

/* ---------- Modeller ---------- */
async function loadModels(){
  const base='./models/';
  await faceapi.nets.tinyFaceDetector.load(base);
  await faceapi.nets.faceExpressionNet.load(base);
  await faceapi.nets.ageGenderNet.load(base); // age only
  try { await faceapi.nets.faceLandmark68Net.load(base); LANDMARKS_AVAILABLE = true; } catch(e){ LANDMARKS_AVAILABLE = false; }
}

/* ---------- ‚Äù√Ñcklad‚Äù-heuristik m.h.a. mun-√∂ppning ---------- */
function mouthAspectRatio(landmarks){
  if(!landmarks) return 0;
  const pts = landmarks.getMouth();
  const dist = (a,b)=> Math.hypot(a.x-b.x, a.y-b.y);
  const top = pts[13], bot = pts[19], left = pts[0], right = pts[6];
  const vert = dist(top, bot);
  const horiz = dist(left, right) + 1e-6;
  return vert / horiz;
}

/* ---------- Huvudloop ---------- */
async function tick(){
  scheduleResetIfNeeded();

  const now = performance.now();
  const dt = Math.min(0.1, (now - lastFrameTime)/1000); lastFrameTime = now;

  const options = new faceapi.TinyFaceDetectorOptions({ inputSize: DETECTOR_SIZE, scoreThreshold: 0.6 });

  let p = faceapi.detectAllFaces(video, options).withFaceExpressions().withAgeAndGender();
  if (LANDMARKS_AVAILABLE) p = p.withFaceLandmarks();

  const dets = await p;
  ctx.clearRect(0,0,overlay.width,overlay.height);

  for (const det of dets){
    const b = det.detection.box; const bbox=[b.x,b.y,b.width,b.height];

    // matcha track
    let best=null, bestIoU=0; tracks.forEach(t=>{ const i=iou(t.bbox,bbox); if(i>bestIoU){bestIoU=i; best=t;} });
    if(best && bestIoU>0.3){ best.bbox=bbox; best.last=now; } else { const t={id:nextId++,bbox,last:now,happyStreak:0,counted:false,seenFrames:0,peppText:null,lastPepp:0,effectSet:null}; tracks.push(t); assignEffects(t); }
    const tr=(best && bestIoU>0.3)? best : tracks[tracks.length-1];

    // emotion
    const exp=det.expressions||{}; let emo=null, conf=0; for (const [k,v] of Object.entries(exp)) if (v>conf){ emo=k; conf=v; }
    const age = det.age ? Math.round(det.age) : null;

    // Heuristik: boosta "disgusted" vid stor mun-√∂ppning (om landmarks finns)
    if (LANDMARKS_AVAILABLE && det.landmarks) {
      const mar = mouthAspectRatio(det.landmarks);
      const happy = exp.happy || 0, neutral = exp.neutral || 0;
      if (mar > 0.42 && happy < 0.4 && neutral < 0.6) {
        if ((exp.disgusted || 0) < 0.6) exp.disgusted = 0.6;
        if (exp.disgusted >= conf) { emo = 'disgusted'; conf = exp.disgusted; }
      }
    }

    tr.seenFrames++; if(!tr.counted && tr.seenFrames===30){ const key=todayKey(); visitorsByDay[key]=(visitorsByDay[key]||0)+1; localStorage.setItem('moodcam.visitors', JSON.stringify(visitorsByDay)); updateLogInfo(); tr.counted=true; }

    if (emo==='happy' && conf>=EMO_CONF_MIN){ tr.happyStreak += dt; if(tr.happyStreak>=5){ meterTarget += 1; tr.happyStreak=0; } } else tr.happyStreak=0;

    // ritning
    const [x,y,w,h]=tr.bbox;
    const color=EMO_COLOR[emo]||'#24ff78';
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.strokeRect(x,y,w,h);

    if (emo && conf>=EMO_CONF_MIN){ const label=`${EMO_SV[emo]||emo} ¬∑ ${Math.round(conf*100)}%` + (age?` ¬∑ ${age} √•r`:''); drawLabel(x,y,label); }
    else if (age){ drawLabel(x,y,`${age} √•r`); }

    // Emoji med centrum exakt i √∂vre h√∂gra h√∂rnet
    const emoji = EMO_EMOJI[emo] || "üôÇ";
    const emSize = Math.max(28, Math.round(Math.min(w,h)*0.22));
    ctx.font = `${emSize}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(emoji, x + w, y);
    // √Öterst√§ll s√• v√•ra box-texter alltid f√•r r√§tt bakgrunder
    ctx.textAlign = 'left';
    ctx.textBaseline = 'alphabetic';

    // Teman (PNG)
    drawEffects(tr, x,y,w,h);

    // Pepp nederst i varje ruta
    if (peppEnabled){
      if (!tr.peppText || (now - tr.lastPepp) > PEPP_INTERVAL){ tr.peppText = randomPepp(); tr.lastPepp = now; }
      drawCenteredBottom(x,y,w,h,tr.peppText);
    }
  }

  // rensa gamla tracks
  const tnow = performance.now();
  for (let i=tracks.length-1;i>=0;i--) if (tnow - tracks[i].last > 1500) tracks.splice(i,1);

  // meter easing
  meterShown = meterShown + (meterTarget - meterShown) * METER_EASE;
  document.getElementById('meterFill').style.width = Math.max(0,Math.min(100,meterShown)) + '%';
  document.getElementById('meterVal').textContent = Math.round(meterShown);

  requestAnimationFrame(tick);
}

/* ---------- Logg / CSV ---------- */
function updateLogInfo(){ const list=Object.entries(visitorsByDay).sort(([a],[b])=>a.localeCompare(b)); const txt=list.length? list.map(([d,n])=>`${d}: ${n}`).join(' ¬∑ ') : 'Ingen logg √§n.'; const el=document.getElementById('logInfo'); if(el) el.textContent=txt; }
function downloadCSV(){ const rows=[['date','visitors'],...Object.entries(visitorsByDay)]; const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='moodcam_visitors.csv'; a.click(); URL.revokeObjectURL(a.href); }

/* ---------- Init & UI ---------- */
(async function init(){
  video=document.getElementById('video'); overlay=document.getElementById('overlay'); ctx=overlay.getContext('2d');

  document.getElementById('settingsBtn').addEventListener('click', ()=>{ const s=document.getElementById('settings'); s.style.display = (s.style.display==='none' || !s.style.display) ? 'block' : 'none'; });

  document.getElementById('conf').addEventListener('input', e=> EMO_CONF_MIN=parseFloat(e.target.value));
  document.getElementById('inputSize').addEventListener('input', e=> DETECTOR_SIZE=parseInt(e.target.value,10));

  document.getElementById('peppToggle').addEventListener('change', e=> { peppEnabled=e.target.checked; });
  document.getElementById('peppCat').addEventListener('change', e=> { peppCat=e.target.value; });

  document.getElementById('themeToggle').addEventListener('change', e=> { themeEnabled=e.target.checked; });
  document.getElementById('themeSel').addEventListener('change', async e=> { themeName=e.target.value; await loadThemeManifest(themeName); });

  document.getElementById('dlLog').addEventListener('click', downloadCSV);
  document.getElementById('clearLog').addEventListener('click', ()=> { localStorage.setItem('moodcam.visitors','{}'); for (const k in visitorsByDay) delete visitorsByDay[k]; updateLogInfo(); });

  await loadModels();
  await listCams(1);
  document.getElementById('camSel').addEventListener('change', async e=> { await startCamera(e.target.value); });

  document.getElementById('start').addEventListener('click', async ()=>{
    const sel=document.getElementById('camSel');
    await startCamera(sel.value);
    new ResizeObserver(()=>{ overlay.width=video.videoWidth; overlay.height=video.videoHeight; overlay.style.width=video.clientWidth+'px'; overlay.style.height=video.clientHeight+'px'; }).observe(document.getElementById('wrap'));
    requestAnimationFrame(tick);
    document.getElementById('start').disabled = true;
  });
})();
</script>

<!-- Exempel p√• tema-manifest
{
  "hats":    ["hats/santa1.png", "hats/witch1.png"],
  "glasses": ["glasogon/nerd1.png", "glasogon/sunglasses2.png"],
  "teeth":   ["huggtander/fangs1.png"],
  "beard":   ["skagg/beard1.png"],
  "makeup":  ["smink/blush1.png"],
  "mouths":  ["munnar/smile1.png"]
}
-->
</body>
</html>
