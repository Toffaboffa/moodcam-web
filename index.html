<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Vialundskolans MoodCam (v.1.3.8)</title>
  <link rel="icon" href="data:,">
<style>
  :root{--bg:#0b0f14;--fg:#e7effa;--panel:#0f172a;--panel2:#111827;--border:#1f2937;--accent:#22c55e}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,sans-serif}
  #stage{display:grid;grid-template-columns:1fr;gap:16px;height:100vh;align-items:center;justify-items:center;padding:12px}

  .topbar{position:fixed;top:10px;left:10px;display:flex;gap:8px;z-index:10}
  .btn{background:var(--panel2);border:1px solid var(--border);color:var(--fg);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .layer-wrap{position:relative;display:inline-block;border-radius:12px;overflow:hidden;box-shadow:0 12px 36px rgba(0,0,0,.5);max-width:96vw;max-height:86vh}

  /* Vi spegelv√§nder INTE l√§ngre dolda videon ‚Äì vi speglar i kompositen via canvasritningen */
  .layer-wrap.mirror video { transform: none; }

  /* Visa komposit & overlay, d√∂lj r√•video visuellt men beh√•ll m√•tt */
  #video{
    visibility:hidden;
    width:100%;
    height:auto;
    position:relative;
    z-index:0;
  }
  #composite{ position:absolute; inset:0; width:100%; height:100%; z-index:0; }
  #overlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:1; }

  #meterWrap{
    position:absolute; left:50%; transform:translateX(-50%); bottom:0;
    background:var(--panel); border:1px solid var(--border);
    border-bottom-left-radius:0; border-bottom-right-radius:0;
    border-top-left-radius:10px; border-top-right-radius:10px;
    padding:6px 10px; width:min(360px,70%); z-index:2;
  }

  #meterBar{position:relative;height:8px;background:#0d1218;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
  #meterFill{height:100%;width:0%;background:linear-gradient(90deg,#2dd4bf,#22c55e)}
  .meterVal{position:absolute;right:6px;top:-16px;opacity:.85}
  .small{font-size:12px;opacity:.8}

  #settings{display:none;position:fixed;right:12px;top:52px;width:360px;max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px 12px 8px;z-index:20}
  #settings h3{margin:6px 0 8px 0;font-size:16px}
  #settings .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
  #settings label{font-size:14px}

  details{border:1px dashed var(--border);border-radius:8px;padding:6px;margin-top:8px}
  summary{cursor:pointer}
  .desc{font-size:12px;opacity:.75;margin:4px 0 0}
  input[type="range"]{width:190px}
  .two-col{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
  .hud{position:fixed;left:14px;bottom:14px;font-size:12px;opacity:.7}
</style>
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm@4.21.0/dist/tf-backend-wasm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1.167/selfie_segmentation.js"></script>
</head>
<body>
  <div class="topbar">
    <button id="start" class="btn">Starta kamera</button>
    <button id="settingsBtn" class="btn" aria-label="√ñppna inst√§llningar">Settings</button>
  </div>

  <div id="stage">
    <div class="layer-wrap" id="wrap">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="composite"></canvas>
      <canvas id="overlay"></canvas>

      <div id="meterWrap">
        <div id="meterBar">
          <div id="meterFill"></div>
          <span id="meterVal" class="small meterVal" aria-live="polite">0</span>
        </div>
        <div class="small" style="margin-top:2px">
          Moodm√§tare ‚Äì B√∂rjar √∂ka efter <em>3s</em>, s√• SMILE üòÑ
        </div>
      </div>

      <video id="ghost" playsinline muted></video>
    </div>
  </div>

  <div id="settings">
    <h3>Settings</h3>
    <div class="row">
      <label for="camSel">Kamera</label>
      <select id="camSel" class="btn" style="width:220px"></select>
    </div>
    <div class="row">
      <label for="conf">Konfidens (etikett)</label>
      <input id="conf" type="range" min="0.2" max="0.9" step="0.05" value="0.40">
    </div>
    <div class="row">
      <label for="inputSize">Detector size</label>
      <input id="inputSize" type="range" min="224" max="512" step="32" value="320">
    </div>
    <div class="row">
      <label for="score">Detektor-tr√∂skel</label>
      <input id="score" type="range" min="0.40" max="0.80" step="0.01" value="0.60">
    </div>

    <details>
      <summary>Peppande one-liners</summary>
      <div class="row" style="margin-top:8px">
        <label>Aktivera</label><input type="checkbox" id="peppToggle" checked>
      </div>
      <div class="row">
        <label for="peppCat">Kategori</label>
        <select id="peppCat" class="btn" style="width:220px"></select>
      </div>
      <p class="desc">Visas i varje ansiktsruta, l√•ses per person tills de l√§mnar bild. Kategorier och texter l√§ses fr√•n <code>pepp.json</code>.</p>
    </details>

    <details>
      <summary>Overlays & teman</summary>
      <div class="row">
        <label>Aktivera overlays</label><input type="checkbox" id="overlayToggle">
      </div>
      <div class="row">
        <label for="themeSel">Tema</label>
        <select id="themeSel" class="btn" style="width:220px"></select>
      </div>
      <div class="row"><label>Hattar</label><input type="checkbox" id="ovHats"></div>
      <div class="row"><label>Glas√∂gon</label><input type="checkbox" id="ovGlasses" checked></div>
      <div class="row"><label>√ñgon</label><input type="checkbox" id="ovEyes"></div>
      <div class="row"><label>Munnar</label><input type="checkbox" id="ovMouth"></div>
      <div class="row"><label>Sk√§gg</label><input type="checkbox" id="ovBeard"></div>
      <div class="row"><label>Visa ansiktsruta</label><input type="checkbox" id="showBox"></div>
      <p class="desc">Tema anger *vilka filer*; passform kommer fr√•n <code>img/assets/meta.json</code>.</p>
    </details>

    <details>
      <summary>Kamera ‚Äì bild (filter)</summary>
      <div class="two-col">
        <label for="fBrightness">Ljusstyrka</label><input id="fBrightness" type="range" min="50" max="150" step="1" value="100">
        <label for="fContrast">Kontrast</label><input id="fContrast"   type="range" min="50" max="150" step="1" value="100">
        <label for="fSaturate">M√§ttnad</label><input id="fSaturate"    type="range" min="0"  max="200" step="1" value="100">
        <label for="fHue">Ton (¬∞)</label><input id="fHue"              type="range" min="-180" max="180" step="1" value="0">
        <label for="fTemp">Temperatur</label><input id="fTemp"         type="range" min="-50" max="50" step="1" value="0">
        <label for="mirrorX">Spegelv√§nd bild</label><input id="mirrorX" type="checkbox" checked>
      </div>
      <div class="row"><button id="filtersReset" class="btn">√Öterst√§ll</button></div>
      <p class="desc">P√•verkar bara visningen (inte detekteringen).</p>
    </details>

    <details>
      <summary>Bes√∂kslogg</summary>
      <div class="row" style="margin-top:8px">
